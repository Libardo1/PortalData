---
title: "Landsat data processing"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(raster)
library(rgdal)
library(dplyr)
library(ggplot2)

source('Landsat_functions.R')

```

## R Markdown
This document describes the process we used to obtain a time series of NDVI for Portal from the Landsat satellites.
Raw data was obtained from earthexplorer.usgs.gov -- a GUI which I used to search for images that cover the Portal area. I downloaded these as GeoTIFF, which include the raster of NDVI data, a raster of cloud mask data (indicating pixels that are cloud), and metadata. Note: all raster images are projected using UTM, with datum WGS84. (more info on the Landsat products can be found at landsat.usgs.gov)

General procedure:
  1. Crop NDVI to 5 km^2 square centered over the Portal Project
  2. Use cloud mask to set NDVI pixels under cloud cover to NA
  3. Summarize data in each image (min, max, median, %cloud etc)
  4. Combine all image summaries into one big data frame (saved as Landsat_all.csv)
     (at this point I filtered out images with >50% cloud cover, insufficient information)
  5. Identify sections of overlap between satellites, calculate correction factor if necessary
  6. Calculate average monthly NDVI

For now, I'm going to start at step 4. Here's a plot of the raw data, color coded by satellite
```{r, echo=FALSE}
allsats = read.csv('Landsat_raw.csv')
allsats$date = as.Date(paste(allsats$year,allsats$julianday),format='%Y %j')

allsats_filtered = remove_cloud_images(allsats,50)

 ggplot(allsats_filtered,aes(x=date,y=median,col=factor(satellite))) +
   geom_point() +
   theme(axis.title.x=element_blank())
```

The Landsat4 satellite doesn't have many images, so it's not practical to try to compute a correction factor. But also since there are so few, folding these points in to the monthly averages probably won't harm anything either so I'll leave them in.

Landsat7 has some issues. From 1999-2003 everything was working fine. However 2011-2014 a thing called SLC was off, which resulted in large spatial bands of missing data. Unfortunately this is the only source of data 2011-2013 so I'm going to use what I can. I'll use the overlap with Landsat5 in 2011 to estimate a correction factor.

Landsat8 came online in 2013 and continues to the present. Again, it overlaps with Landsat7(slcoff) for about 2 years, so we can use this to compare the satellites.

[You may have noticed there is no Lansat6. It blew up on the launch pad.]


## Satellite overlap

I'm going to look at three sections of satellite overlap:
  - Landsat5 vs Landsat7 (SLC on) 1999-2003
  - Landsat5 vs Landsat7 (SLC off) 2011
  - Landsat7 (SLC off) vs Landsat8 2013-2014

```{r, echo=FALSE}
# Landsat5 vs Landsat7 (SLC on)
L7on = filter(allsats_filtered,satellite==7)
L5 = filter(allsats_filtered,satellite==5) 

# find images from L5 within 3 days of L7on image
L5_L7on = find_matching_image(L7on,L5)
names(L5_L7on) = c('L5_date','L5_ndvi','L7on_date','L7on_ndvi')
# write to csv if you want
# write.csv(L5_L7on,'L5_L7on_comparison.csv',row.names=F)
ggplot(L5_L7on) +
  geom_point(aes(x=L5_ndvi,y=L7on_ndvi)) +
  geom_abline(slope=1,intercept=0)

# linear regressions for overlapping satellites
L5L7on = NDVI_regression(L5_L7on$L5_ndvi,L5_L7on$L7on_ndvi)
L5L7on  #pvalue is .55

```

Doesn't look bad. At least the bias isn't systematic.

```{r, echo=FALSE}
# Landsat5 vs Landsat7 (SLC off)
L7off = filter(allsats_filtered,satellite==7.5)
L5 = filter(allsats_filtered,satellite==5) 

# find images from L5 within 3 days of L7on image
L5_L7off= find_matching_image(L7off,L5)
names(L5_L7off) = c('L5_date','L5_ndvi','L7off_date','L7off_ndvi')
# write to csv if you want
# write.csv(L5_L7off,'L5_L7off_comparison.csv',row.names=F)
ggplot(L5_L7off) +
  geom_point(aes(x=L5_ndvi,y=L7off_ndvi)) +
  geom_abline(slope=1,intercept=0)

# regression
L5L7off = NDVI_regression(L5_L7off$L5_ndvi,L5_L7off$L7off_ndvi)
L5L7off # pvalue is .02
```

Not great. Correction factor seems necessary.


```{r, echo=FALSE}
L7off_corrected = L7off %>% select(satellite,path,rows,year,julianday,groundstation,version,median,numpixels,pctcloud,date)
L7off_corrected$median = Apply_correction(L7off$median,L5L7off)

L5_L7off_corrected= find_matching_image(L7off_corrected,L5)
names(L5_L7off_corrected) = c('L5_date','L5_ndvi','L7off_date','L7off_ndvi')

ggplot(L5_L7off_corrected) +
  geom_point(aes(x=L5_ndvi,y=L7off_ndvi)) +
  geom_abline(slope=1,intercept=0)
```

```{r, echo=FALSE}
# Landsat8 vs Landsat7 (SLC off) using corrected Landsat7off from previous regression
L8 = filter(allsats_filtered,satellite==8) 

# find images from L5 within 3 days of L7on image
L8_L7off = find_matching_image(L7off_corrected,L8)
names(L8_L7off) = c('L8_date','L8_ndvi','L7off_date','L7off_ndvi')
# write to csv if you want
# write.csv(L8_L7off,'L8_L7off_comparison.csv',row.names=F)
ggplot(L8_L7off) +
  geom_point(aes(x=L8_ndvi,y=L7off_ndvi)) +
  geom_abline(slope=1,intercept=0)

# regression
L8L7off = NDVI_regression(L8_L7off$L8_ndvi,L8_L7off$L7off_ndvi)
L8L7off # pvalue is .10
```

## Calculate monthly NDVI

In the previous section I calculated a correction factor for the data from Landsat7 (SLC off).  All satellites can now be combined to compute monthly time series

```{r, echo=FALSE}
allsats_corrected = rbind(
  select(L5,satellite,median,date),
  select(L7on,satellite,median,date),
  select(L7off_corrected,satellite,median,date),
  select(L8,satellite,median,date))

allsats_corrected = allsats_corrected[order(allsats_corrected$date),]
allsats_corrected$year = format(allsats_corrected$date,'%Y')
allsats_corrected$month = as.integer(format(allsats_corrected$date,'%m'))

monthly_ndvi = aggregate(allsats_corrected$median,by=list(year = allsats_corrected$year, month = allsats_corrected$month),FUN=mean)


# find any gaps and put in NAs
allmonths = expand.grid(1:12,min(monthly_ndvi$year):max(monthly_ndvi$year))
names(allmonths) = c('month','year')

monthly_ndvi = merge(allmonths,monthly_ndvi,all.x=T)
monthly_ndvi = monthly_ndvi[order(monthly_ndvi$year,monthly_ndvi$month),]
write.csv(monthly_ndvi,'Landsat_monthly_NDVI.csv',row.names=F)
```

